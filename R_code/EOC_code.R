#packageslibrary(tidyverse)library(epitools)library(tidycensus)library(readxl)library(sf)library(cartography)library(spdep)library(cowplot)library(gridGraphics)library(gdata)library(patchwork)library(tmap)#county shapefileus<-unique(fips_codes$state)[1:51]cou<-get_acs(year=2010,geography="county",state=us,survey = "acs5",variables="B01001_001",geometry=T)cou$st<-substr(cou$GEOID,start=1,stop=2)cou<-cou[which(cou$st!="78" & cou$st!="72" & cou$st!="02" & cou$st!="15"),]cou<-st_transform(cou,crs=3857)cou$one<-1#read in datars_y_sf4 <- st_read("SPATIAL FILE")rs_o_sf4 <- st_read("SPATIAL FILE")#creating neighborhoods#early-onsetrs_y_sf<-st_drop_geometry(rs_y_sf4)rs_y_sf<-st_as_sf(rs_y_sf,coords = c("LONGITUDE","LATITUDE"), crs=4326)knn <- knearneigh(rs_y_sf, k=8)nb <- knn2nb(knn)nb <- make.sym.nb(nb)#average-onsetrs_o_sf<-st_drop_geometry(rs_o_sf4)rs_o_sf<-st_as_sf(rs_o_sf,coords = c("LONGITUDE","LATITUDE"), crs=4326)knn2 <- knearneigh(rs_o_sf, k=8)nb2 <- knn2nb(knn2)nb2 <- make.sym.nb(nb2)#INLA#install INLA here:https://www.r-inla.org/download-installlibrary(INLA)#early-onset graphsnb2INLA("map.adj", nb)gr <- inla.read.graph(filename = "map.adj")rs_y_sf4$idarea <- 1:nrow(rs_y_sf4)#average onset graphsnb2INLA("map.adj2", nb2)gr2 <- inla.read.graph(filename = "map.adj2")rs_o_sf4$idarea <- 1:nrow(rs_o_sf4)#priors set up based on rule of thumb (Simpson et al. 2017)prior <- list(  prec = list(    prior = "pc.prec",    param = c(0.5 / 0.31, 0.01)),  phi = list(    prior = "pc",    param = c(0.5, 2 / 3)))#unadjusted formulaformula_un <- age_adj_count ~ 1 +  f(idarea, model = "bym2", graph = gr, scale.model = T, hyper = prior)#adjusted formula ###NOTE: REMOVE PCT_FEM WHEN USING BREAST CANCER DATAformula <- age_adj_count ~ ADI + b0049_pct + h0049_pct + ob_cdc + sm_mean + al_mean + unins_pct0054 + pct_fem +  f(idarea, model = "bym2", graph = gr, scale.model = T, hyper = prior)formula2 <- age_adj_count ~ ADI + b50_pct + h50_pct + ob_cdc + sm_mean + al_mean + unins_pct55 + pct_fem +  f(idarea, model = "bym2", graph = gr2, scale.model = T, hyper = prior)#unadjusted models mortality#early-onsetres_un <- inla(formula_un,               family = "poisson", data = rs_y_sf4,               E = expected, control.predictor = list(compute = TRUE),               control.compute=list(return.marginals.predictor=TRUE, dic=T),               control.inla = list(int.strategy = "ccd"))#average-onsetres_un2 <- inla(formula_un,                family = "poisson", data = rs_o_sf4,                E = expected, control.predictor = list(compute = TRUE),                control.compute=list(return.marginals.predictor=TRUE, dic=T),                control.inla = list(int.strategy = "ccd"))#adjusted models mortality#early-onsetres <- inla(formula,            family = "poisson", data = rs_y_sf4,            E = expected, control.predictor = list(compute = TRUE),            control.compute=list(return.marginals.predictor=TRUE, dic=T, config=T, waic=T,cpo=T),            control.inla = list(int.strategy = "ccd"))#average-onsetres2 <- inla(formula2,             family = "poisson", data = rs_o_sf4,             E = expected, control.predictor = list(compute = TRUE),             control.compute=list(return.marginals.predictor=TRUE, dic=T, waic=T,cpo=T),             control.inla = list(int.strategy = "ccd"))#begin plottinglibrary(ggplot2)#inlatools and other checkslibrary(inlatools)d<-inlatools::dispersion_check(res)d<-inlatools::dispersion_check(res2)unique(res$cpo$failure)unique(res2$cpo$failure)#no failures#testing marginal plots#early-onsetmarginal <- inla.smarginal(res$marginals.fixed$unins_pct)marginal <- data.frame(marginal)ggplot(marginal, aes(x = x, y = y)) + geom_line() +  labs(x = expression(beta[1]), y = "Density") + ggtitle("Posterior distribution of coefficient for uninsured") +  geom_vline(xintercept = 0, col = "black") + theme_bw()#average-onsetmarginal2 <- inla.smarginal(res2$marginals.fixed$unins_pct)marginal2 <- data.frame(marginal2)ggplot(marginal2, aes(x = x, y = y)) + geom_line() +  labs(x = expression(beta[1]), y = "Density") + ggtitle("Posterior distribution of coefficient for uninsured") +  geom_vline(xintercept = 0, col = "black") + theme_bw()#creating relative risks & transforming for plotting#early-onsetrs_y_sf4$RR <- res$summary.fitted.values[, "mean"]rs_y_sf4$LL <- res$summary.fitted.values[, "0.025quant"]rs_y_sf4$UL <- res$summary.fitted.values[, "0.975quant"]rs_y_sf4<-st_transform(rs_y_sf4,crs=3857)#average-onsetrs_o_sf4$RR <- res2$summary.fitted.values[, "mean"]rs_o_sf4$LL <- res2$summary.fitted.values[, "0.025quant"]rs_o_sf4$UL <- res2$summary.fitted.values[, "0.975quant"]rs_o_sf4<-st_transform(rs_o_sf4,crs=3857)#RR plots#early-onsetlegend_title2<-"RR"psup_RR_eo<-tm_shape(cou) + tm_polygons("one",legend.show=F,alpha=0.5) + tm_shape(rs_y_sf4)+ tm_borders(lwd=0) + tm_polygons("RR",   palette="viridis",breaks=c(0,0.5,1,1.5,2,2.5,3,3.5,Inf), legend.show=T, title=legend_title2, colorNA="lightgrey") +  tm_compass() + tm_scale_bar(position=0.78, width=0.1) + tm_credits("Pale yellow = Suppressed",position=c("center","bottom")) +  tm_layout(frame = FALSE)#view plotpsup_RR_eo#If you would like to save#tmap_save(psup_RR_eoas, "YOURPATH", dpi=400, width=8, height=5)#average-onsetpsup_RR_ao<-tm_shape(cou) + tm_polygons("one",legend.show=F,alpha=0.5) + tm_shape(rs_o_sf4)+ tm_borders(lwd=0) + tm_polygons("RR",   palette="viridis",breaks=c(0,0.5,1,1.5,2,2.5,3,3.5,Inf), legend.show=T, title=legend_title2, colorNA="lightgrey") +  tm_compass() + tm_scale_bar(position=0.78, width=0.1) + tm_credits("Pale yellow = Suppressed",position=c("center","bottom")) +  tm_layout(frame = FALSE)#viewpsup_RR_ao#If you would like to save#tmap_save(psup_RR_aoas, "/Users/blakebuchalter/Downloads/psup_RR_aoas.png", dpi=400, width=8, height=5)#Exceedance probabilities#select any year 2010-2019 to get 2010 census county shapesst<-get_acs(year=2014,geography="state",variables = c("B01001_001"), geometry = T)st<-st_transform(st,crs=3857)st$st<-substr(st$GEOID,start=1,stop=2)st<-st[which(st$st!="72" & st$st!="78" & st$st!="15" & st$st!="02"),]st$one<-1#Calculating exc for RR=1.5#early-onsetexc <- sapply(res$marginals.fitted.values,              FUN = function(marg){1 - inla.pmarginal(q = 1.5, marginal = marg)})rs_y_sf4$exc <- exc#average-onsetexc2 <- sapply(res2$marginals.fitted.values,               FUN = function(marg){1 - inla.pmarginal(q = 1.5, marginal = marg)})rs_o_sf4$exc <- exc2#Plot exceedance probabilities#takes a bit longer to produce #early-onsetplot(rs_y_sf4["exc"],border=NA,main=NA,key.pos=1, pal=hcl.colors(10,"Heat",rev=T),reset=F)plot(cou["one"],border="darkgray", col="gray",main=NA,key.pos=NA,reset=F,add=T)plot(rs_y_sf4["exc"],border=NA,main=NA,key.pos=NA, pal=hcl.colors(10,"Heat",rev=T),reset=F,add=T)plot(st["one"],border="white", col=sf.colors(1,alpha=0), add=T)mtext('Exceedance Probability (Grey = suppressed)',side=1)p_all_50 <- recordPlot()p1 <- plot_grid(p_all_50)p1 + labs(tag="A") + theme(plot.tag.position = c(0.05,0.95))#If you would like to save#ggsave("YOURPATH",dpi=400)#average-onsetplot(rs_o_sf4["exc"],border=NA,main=NA,key.pos=1, pal=hcl.colors(10,"Heat",rev=T),reset=F)plot(cou["one"],border="darkgray", col="gray",main=NA,key.pos=NA,reset=F,add=T)plot(rs_o_sf4["exc"],border=NA,main=NA,key.pos=NA, pal=hcl.colors(10,"Heat",rev=T),reset=F,add=T)plot(st["one"],border="white", col=sf.colors(1,alpha=0), add=T)mtext('Exceedance Probability (Grey = suppressed)',side=1)p_all_50 <- recordPlot()p1 <- plot_grid(p_all_50)p1 + labs(tag="A") + theme(plot.tag.position = c(0.05,0.95))#If you would like to save#ggsave("YOURPATH",dpi=400)